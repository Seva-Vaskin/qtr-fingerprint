pipeline {

    agent {
        docker {
            image 'rikorose/gcc-cmake:latest'
            args '-v /home/ubuntu/SFO:/home/ubuntu/workspace/slow-tests/SFO'
        }
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '100', daysToKeepStr: '100',  artifactNumToKeepStr: '100', artifactDaysToKeepStr: '100'))
    }

    triggers{
        pollSCM('H/15 * * * *')
    }

    stages {

        stage('build') {
            steps {
                sh '''
                    cd cpp
                    mkdir -p build && cd build
                    cmake ..
                    cmake --build . -j10
                '''
            }
        }

        stage('test') {
            steps {
                sh '''
                    cd cpp/build
                    export GLOG_logtostdout=true
                   ./bin/tests --gtest_output="xml:./report.xml" --big_data_dir_path=/home/ubuntu/workspace/slow-tests/SFO --gtest_filter='SlowTest*'
                '''
            }
        }

    }

    post {
        always {
            junit 'cpp/build/report.xml'
        }
        cleanup {
            deleteDir()
        }
    } 

}
